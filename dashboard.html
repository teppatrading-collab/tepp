<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teppa Trading | Pro Terminal</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
        const supabaseUrl = 'https://xuifnaypkeeukyjvlapi.supabase.co';
        const supabaseKey = 'sb_publishable_44vXTyFg__8x2Ohqa8KGuA_OV9HX2ob';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let ACCOUNT_GOAL = localStorage.getItem('tradingGoal') ? parseInt(localStorage.getItem('tradingGoal')) : 10000;
        let activeFilter = 'all'; 
        let activeTimeframe = 'all'; 
        let sessionChart, equityChart, psychChart;
        let currentEditId = null; 
        let allTradesCache = []; 

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) window.location.replace("index.html");
            else {
                document.getElementById('userEmail').innerText = session.user.email;
                checkProSubscription(session.user.id);
                loadTrades();
                setDefaultSession();
            }
        }
        checkAuth();

        // --- PRO PROTECTION LOGIC ---
        async function checkProSubscription(userId) {
            const { data, error } = await supabaseClient
                .from('subscriptions')
                .select('plan, status')
                .eq('user_id', userId)
                .single();

            const proSection = document.getElementById('proSection');
            if (data && data.plan === 'pro' && data.status === 'active') {
                proSection.style.display = 'block';
                loadLeaderboard();
            } else {
                proSection.style.display = 'none';
            }
        }

        // --- TAB TOGGLE LOGIC ---
        function switchProTab(tab) {
            document.getElementById('tab-leaders').classList.toggle('active-filter', tab === 'leaders');
            document.getElementById('tab-ai').classList.toggle('active-filter', tab === 'ai');
            document.getElementById('content-leaders').style.display = (tab === 'leaders') ? 'block' : 'none';
            document.getElementById('content-ai').style.display = (tab === 'ai') ? 'block' : 'none';
            if(tab === 'leaders') loadLeaderboard();
        }

        async function loadLeaderboard() {
            const list = document.getElementById('leaderboardList');
            const { data } = await supabaseClient
                .from('trades')
                .select('pnl, created_at')
                .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString())
                .order('pnl', { ascending: false }).limit(5);

            if (data) {
                list.innerHTML = data.map((t, i) => `
                    <div class="leader-row">
                        <span><span class="rank-num">${i+1}</span> TRADER_${Math.floor(Math.random()*900)}</span>
                        <strong style="color:var(--primary)">+$${t.pnl.toLocaleString()}</strong>
                    </div>
                `).join('');
            }
        }

        async function runAIAnalysis() {
            const res = document.getElementById('aiResponse');
            res.innerHTML = `<div style="color:var(--primary)"><i class='bx bx-loader-alt bx-spin'></i> Analyzing pattern data...</div>`;
            if (allTradesCache.length < 5) {
                setTimeout(() => { res.innerHTML = "‚ùå AI requires at least 5 logged trades."; }, 1500);
                return;
            }
            setTimeout(() => {
                res.innerHTML = `<strong>INSIGHT:</strong> You are most profitable during <strong>New York</strong>. <br><strong>RISK:</strong> High correlation between losses and <strong>FOMO</strong> emotion.`;
            }, 2000);
        }

        // --- EXISTING UTILITIES ---
        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('active'); }
        function updateWidget() {
            const pair = document.getElementById('tradePair').value.toUpperCase() || 'NAS100';
            document.getElementById('tv-widget').src = `https://s.tradingview.com/embed-widget/mini-symbol-overview/?locale=en#{"symbol":"${pair}","width":"100%","height":"100%","colorTheme":"dark","isTransparent":true}`;
        }
        function setDefaultSession() {
            const hour = new Date().getHours();
            let s = "Asian";
            if (hour >= 8 && hour < 14) s = "London";
            if (hour >= 14 && hour < 21) s = "New York";
            document.getElementById('tradeSession').value = s;
        }
        function toggleStrategy(btn) { btn.classList.toggle('active-strat'); }
        function getSelectedStrategies(id) {
            return Array.from(document.getElementById(id).querySelectorAll('.strat-btn.active-strat')).map(b => b.innerText).join(', ');
        }

        async function saveTradeWithImage() {
            const pair = document.getElementById('tradePair').value;
            const pnl = document.getElementById('tradePnL').value;
            const { error } = await supabaseClient.from('trades').insert([{
                pair, pnl: parseFloat(pnl), reason: document.getElementById('tradeReason').value,
                outcome: document.getElementById('tradeOutcome').value, session: document.getElementById('tradeSession').value,
                emotion: document.getElementById('tradeEmotion').value, strategy: getSelectedStrategies('newStrategyContainer')
            }]);
            if (!error) { loadTrades(); document.getElementById('journalStatus').innerText = "‚úÖ Saved!"; }
        }

        async function loadTrades() {
            const { data: rawTrades } = await supabaseClient.from('trades').select('*').order('created_at', { ascending: false });
            if (!rawTrades) return;
            allTradesCache = rawTrades;
            const feed = document.getElementById('tradeFeed');
            feed.innerHTML = '';
            
            let netPnL = rawTrades.reduce((acc, t) => acc + (t.pnl || 0), 0);
            document.getElementById('netPnLStat').innerText = "$" + netPnL.toLocaleString();
            document.getElementById('goalFill').style.width = Math.min((netPnL/ACCOUNT_GOAL)*100, 100) + "%";

            rawTrades.forEach(t => {
                const card = document.createElement('div');
                card.className = 'trade-log-card';
                card.innerHTML = `<div style="display:flex; justify-content:space-between;"><b>${t.pair}</b> <span style="color:${t.pnl >=0 ? 'var(--primary)' : '#ef4444'}">$${t.pnl}</span></div><p style="font-size:0.8rem; color:#94a3b8;">${t.reason}</p>`;
                feed.appendChild(card);
            });
            updateEquityChart(rawTrades);
            renderCalendar(rawTrades);
        }

        function renderCalendar(trades) {
            const container = document.getElementById('calendarGrid');
            container.innerHTML = '';
            for(let i=1; i<=31; i++) {
                const day = document.createElement('div');
                day.className = 'cal-day';
                day.innerHTML = `<span class="cal-num">${i}</span>`;
                container.appendChild(day);
            }
        }

        function updateEquityChart(trades) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            const sorted = [...trades].sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
            let bal = 0; const data = sorted.map(t=>{bal+=(t.pnl||0); return bal;});
            if(equityChart) equityChart.destroy();
            equityChart = new Chart(ctx, { type:'line', data:{labels:sorted.map(t=>""), datasets:[{data, borderColor:'#2dd4bf', fill:true, backgroundColor:'rgba(45,212,191,0.05)', tension:0.4}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#334155'}}}}});
        }
    </script>

    <style>
        :root { --primary: #2dd4bf; --secondary: #818cf8; --bg: #0f172a; --card: rgba(30, 41, 59, 0.8); --border: #334155; --text: #f8fafc; }
        body { background: #0f172a; color: var(--text); font-family: sans-serif; margin: 0; }
        .sidebar { width: 280px; height: 100vh; background: #0f172a; border-right: 1px solid var(--border); padding: 20px; position: fixed; overflow-y: auto; }
        .main-content { margin-left: 280px; padding: 40px; }
        .sidebar-section { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .side-input, select, textarea { width: 100%; background: #0f172a; color: white; border: 1px solid var(--border); padding: 8px; margin-bottom: 10px; border-radius: 5px; }
        .side-btn { width: 100%; background: var(--primary); padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; }
        .nav-btn { width: 100%; background: transparent; color: #94a3b8; padding: 10px; text-align: left; border: none; cursor: pointer; }
        .nav-btn.special { background: var(--primary); color: #000; border-radius: 5px; font-weight: bold; margin-bottom: 10px; }
        .strategy-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .strat-btn { font-size: 0.7rem; border: 1px solid var(--border); padding: 4px 8px; border-radius: 12px; cursor: pointer; color: #94a3b8; }
        .strat-btn.active-strat { background: var(--primary); color: #000; border-color: var(--primary); }

        .stats-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 10px; }
        
        /* PRO SECTION STYLES */
        .pro-card { background: var(--card); border: 1px solid var(--primary); padding: 20px; border-radius: 12px; margin-bottom: 25px; display: none; }
        .tab-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .filter-btn { background: transparent; border: 1px solid var(--border); color: #94a3b8; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active-filter { background: var(--primary); color: #000; border-color: var(--primary); }
        .leader-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .rank-num { background: var(--primary); color: #000; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; }
        #aiResponse { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border-left: 3px solid var(--primary); font-size: 0.85rem; line-height: 1.5; }

        .trade-log-card { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .cal-day { aspect-ratio: 1; background: var(--card); border: 1px solid var(--border); border-radius: 5px; display: flex; align-items: center; justify-content: center; position: relative; }
        .cal-num { position: absolute; top: 3px; left: 5px; font-size: 0.6rem; color: #94a3b8; }
        .goal-bar-bg { width: 100%; height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .goal-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="brand-title">TEPPA <span>TRADING</span></div>
        <button class="nav-btn special">üéì ACADEMY</button>
        <button class="nav-btn"><i class='bx bx-news'></i> NEWS</button>
        <button class="nav-btn"><i class='bx bx-brain'></i> PSYCHOLOGY</button>
        
        <div class="sidebar-section">
            <h4 style="font-size:0.7rem; color:#94a3b8;">NEW ENTRY</h4>
            <input type="text" id="tradePair" class="side-input" placeholder="Pair (e.g. NAS100)" onchange="updateWidget()">
            <select id="tradeSession" class="side-input"><option>London</option><option>New York</option><option>Asian</option></select>
            <div id="newStrategyContainer" class="strategy-container">
                <div class="strat-btn" onclick="toggleStrategy(this)">SMT</div>
                <div class="strat-btn" onclick="toggleStrategy(this)">Pro Trend</div>
                <div class="strat-btn" onclick="toggleStrategy(this)">Reversal</div>
            </div>
            <select id="tradeOutcome" class="side-input"><option>Win</option><option>Loss</option></select>
            <input type="number" id="tradePnL" class="side-input" placeholder="PnL ($)">
            <select id="tradeEmotion" class="side-input"><option>Confident</option><option>FOMO</option></select>
            <textarea id="tradeReason" rows="2" class="side-input" placeholder="Notes..."></textarea>
            <button class="side-btn" onclick="saveTradeWithImage()">Save Trade</button>
            <p id="journalStatus" style="font-size:0.7rem; text-align:center;"></p>
        </div>

        <div class="sidebar-section" style="padding:0; height: 160px; background:#000;">
            <iframe id="tv-widget" frameborder="0" style="width:100%; height:100%;"></iframe>
        </div>
        <button onclick="supabaseClient.auth.signOut().then(()=>window.location.replace('index.html'))" style="width:100%; padding:10px; background:transparent; color:#94a3b8; border:1px solid var(--border); border-radius:5px; cursor:pointer;">Log Out</button>
    </aside>

    <main class="main-content">
        <header style="margin-bottom:25px;">
            <h1 style="margin:0;">Dashboard</h1>
            <span id="userEmail" style="color:#94a3b8;">Loading user...</span>
        </header>

        <div class="stats-container">
            <div class="stat-box"><span>Net Profit</span><h3 id="netPnLStat">$0</h3></div>
            <div class="stat-box"><span>Win Rate</span><h3>0%</h3></div>
            <div class="stat-box"><span>Profit Factor</span><h3 style="color:#fbbf24;">‚àû</h3></div>
            <div class="stat-box"><span>Goal Progress</span><div class="goal-bar-bg"><div id="goalFill" class="goal-fill"></div></div></div>
        </div>

        <div id="proSection" class="pro-card">
            <div class="tab-bar">
                <button id="tab-leaders" class="filter-btn active-filter" onclick="switchProTab('leaders')">üèÜ Weekly Leaders</button>
                <button id="tab-ai" class="filter-btn" onclick="switchProTab('ai')">üß† AI Analyst</button>
            </div>

            <div id="content-leaders">
                <h4 style="margin:0 0 10px 0; color:var(--primary); font-size:0.8rem;">GLOBAL TOP PERFORMERS</h4>
                <div id="leaderboardList"></div>
            </div>

            <div id="content-ai" style="display:none;">
                <h4 style="margin:0 0 10px 0; color:var(--primary); font-size:0.8rem;">AI STRATEGY INSIGHTS</h4>
                <div id="aiResponse">Click scan to analyze your recent trade psychology.</div>
                <button onclick="runAIAnalysis()" class="side-btn" style="margin-top:15px; width:auto; padding:8px 20px; background:var(--secondary); color:#fff;">Run Pattern Scan</button>
            </div>
        </div>

        <div style="background:var(--card); padding:20px; border-radius:10px; border:1px solid var(--border); margin-bottom:25px;">
            <div style="margin-bottom:10px; font-weight:bold;">EQUITY CURVE</div>
            <div style="height: 250px;"><canvas id="equityChart"></canvas></div>
        </div>

        <div style="margin-top:25px;">
            <div style="font-weight:bold;">MONTHLY CALENDAR</div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <div id="tradeFeed" style="margin-top:25px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;"></div>
    </main>
</body>
</html>
