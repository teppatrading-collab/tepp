<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teppa Trading | Dashboard</title>
    <link rel="stylesheet" href="style-dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const supabaseUrl = 'https://xuifnaypkeeukyjvlapi.supabase.co';
        const supabaseKey = 'sb_publishable_44vXTyFg__8x2Ohqa8KGuA_OV9HX2ob';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (!session && event === 'INITIAL_SESSION') {
                window.location.replace("index.html");
            } else if (session) {
                document.getElementById('userEmail').innerText = session.user.email;
                document.documentElement.classList.add('authorized');
            }
        });

        // 1. LIVE CLOCK LOGIC
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-GB', { timeZone: 'UTC' });
            document.getElementById('liveClock').innerText = timeString + " UTC";
        }
        setInterval(updateClock, 1000);

        // 2. RISK CALCULATOR LOGIC
        function calculateRisk() {
            const balance = document.getElementById('balance').value;
            const riskPercent = document.getElementById('riskPercent').value;
            const stopLoss = document.getElementById('stopLoss').value;

            if (balance && riskPercent && stopLoss) {
                const riskAmount = balance * (riskPercent / 100);
                const positionSize = (riskAmount / stopLoss).toFixed(2);
                document.getElementById('calcResult').innerText = `Risk: $${riskAmount} | Suggested Lot: ${positionSize}`;
            }
        }

        // 3. TRADING JOURNAL LOGIC
        async function saveTrade() {
            const pair = document.getElementById('tradePair').value;
            const type = document.getElementById('tradeType').value;
            const reason = document.getElementById('tradeReason').value;
            const status = document.getElementById('journalStatus');

            if (!pair || !reason) {
                status.style.color = "#ff4b4b";
                status.innerText = "Please fill in all fields.";
                return;
            }

            const { data, error } = await supabaseClient
                .from('trades')
                .insert([{ pair, type, reason }]);

            if (error) {
                status.style.color = "#ff4b4b";
                status.innerText = "Error saving trade: " + error.message;
            } else {
                status.style.color = "#00ffae";
                status.innerText = "Trade saved successfully!";
                // Clear inputs
                document.getElementById('tradePair').value = '';
                document.getElementById('tradeReason').value = '';
            }
        }

        function toggleMenu() {
            document.querySelector('.sidebar').classList.toggle('active');
        }
    </script>

    <style>
        html:not(.authorized) body { display: none; }
        body { margin: 0; background-color: #0a0e17; color: white; font-family: 'Inter', sans-serif; display: flex; }
        
        .sidebar { width: 240px; background: #161b22; height: 100vh; position: fixed; border-right: 1px solid #30363d; transition: 0.3s; z-index: 1000; }
        .main-content { margin-left: 240px; padding: 20px; width: 100%; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .feature-card { background: #161b22; border: 1px solid #30363d; padding: 20px; border-radius: 12px; }
        
        .clock-box { color: #00ffae; font-size: 1.5rem; font-weight: bold; font-family: monospace; }
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #0d1117; border: 1px solid #30363d; color: white; border-radius: 5px; box-sizing: border-box; }
        .calc-btn { background: #00ffae; color: black; border: none; padding: 10px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 5px; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 200px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            .mobile-header { display: flex; justify-content: space-between; background: #161b22; padding: 15px; border-bottom: 1px solid #30363d; width: 100%; box-sizing: border-box;}
        }
        .mobile-header { display: none; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <div style="color:#00ffae; font-weight:bold;">TEPPA TRADING</div>
        <button onclick="toggleMenu()" style="background:none; border:1px solid #00ffae; color:#00ffae; border-radius:5px;">Menu</button>
    </div>

    <aside class="sidebar">
        <div style="color:#00ffae; font-weight:bold; padding:20px; font-size:1.2rem;">TEPPA TRADING</div>
        <nav style="display:flex; flex-direction:column;">
            <a href="#" style="padding:15px; color:white; text-decoration:none;">Market Overview</a>
            <a href="#" style="padding:15px; color:white; text-decoration:none;">Video Lessons</a>
            <button onclick="supabaseClient.auth.signOut().then(() => window.location.replace('index.html'))" style="margin:20px; background:#ff4b4b; border:none; color:white; padding:10px; border-radius:5px; cursor:pointer;">Logout</button>
        </nav>
    </aside>

    <main class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <div>
                <h1 style="margin:0;">Dashboard</h1>
                <span id="userEmail" style="color:#00ffae; font-size:0.8rem; border:1px solid #00ffae; padding:2px 8px; border-radius:15px;">Loading...</span>
            </div>
            <div class="clock-box" id="liveClock">00:00:00 UTC</div>
        </div>

        <div class="dashboard-grid">
            <div class="feature-card">
                <h3 style="color:#00ffae; margin-top:0;">Risk Calculator</h3>
                <input type="number" id="balance" placeholder="Account Balance ($)">
                <input type="number" id="riskPercent" placeholder="Risk Percentage (%)">
                <input type="number" id="stopLoss" placeholder="Stop Loss (Pips)">
                <button class="calc-btn" onclick="calculateRisk()">Calculate Position</button>
                <p id="calcResult" style="margin-top:15px; font-weight:bold; color:#00ffae;"></p>
            </div>

            <div class="feature-card">
                <h3 style="color:#00ffae; margin-top:0;">Daily Journal</h3>
                <input type="text" id="tradePair" placeholder="Pair (e.g., NAS100)">
                <select id="tradeType">
                    <option value="Buy">Buy</option>
                    <option value="Sell">Sell</option>
                </select>
                <textarea id="tradeReason" placeholder="Reason for entry..."></textarea>
                <button class="calc-btn" onclick="saveTrade()">Save Trade</button>
                <p id="journalStatus" style="font-size: 0.8rem; margin-top: 5px;"></p>
            </div>

            <div class="feature-card">
                <h3 style="color:#00ffae; margin-top:0;">Mentorship Feed</h3>
                <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:8px;">
                    <iframe style="position:absolute; top:0; left:0; width:100%; height:100%;" 
                        src="https://www.youtube.com/embed/dQw4w9WgXcQ" 
                        frameborder="0" allowfullscreen>
                    </iframe>
                </div>
                <p style="font-size:0.8rem; color:#8b949e; margin-top:10px;">Latest Strategy: Market Structure Masterclass</p>
            </div>
        </div>
    </main>
</body>
</html>
