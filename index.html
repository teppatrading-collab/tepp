<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Teppa Trading</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="navbar">
  <div class="logo">TEPPA <span>TRADING</span></div>
  <div>
    <button id="loginBtn" class="outline">Login</button>
    <button id="signupBtn" class="outline">Sign Up</button>
    <button id="logoutBtn" class="outline hidden">Logout</button>
  </div>
</header>
<section class="hero">
  <h1>Master Forex & Indices</h1>
  <p>Education • Discipline • Consistency</p>
  <button id="applyBtn" class="cta">Apply For Mentorship</button>
</section>
<div id="authModal" class="modal hidden">
  <div class="modal-box">
    <h2 id="authTitle">Login</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="submitAuth" class="cta">Submit</button>
    <p id="closeModal" style="cursor:pointer;color:#aaa;">Close</p>
  </div>
</div>

<script>
const supabaseClient = window.supabase.createClient(
  'https://xuifnaypkeeukyjvlapi.supabase.co',
  'sb_publishable_44vXTyFg__8x2Ohqa8KGuA_OV9HX2ob'
)

async function handleAuth() {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  let mode = document.getElementById('authTitle').innerText.toLowerCase() === 'login' ? 'login' : 'signup';
  
  const { data, error } = mode === 'login' 
    ? await supabaseClient.auth.signInWithPassword({ email, password })
    : await supabaseClient.auth.signUp({ email, password });

  if (error) {
      alert(error.message);
  } else {
      // Manual redirect on success
      window.location.replace("dashboard.html"); 
  }
}

function updateUI(loggedIn) {
  document.getElementById('loginBtn').classList.toggle('hidden', loggedIn);
  document.getElementById('signupBtn').classList.toggle('hidden', loggedIn);
  document.getElementById('logoutBtn').classList.toggle('hidden', !loggedIn);
}

document.getElementById('loginBtn').onclick = () => { document.getElementById('authTitle').innerText='Login'; document.getElementById('authModal').classList.remove('hidden'); }
document.getElementById('signupBtn').onclick = () => { document.getElementById('authTitle').innerText='Sign Up'; document.getElementById('authModal').classList.remove('hidden'); }
document.getElementById('logoutBtn').onclick = () => supabaseClient.auth.signOut();
document.getElementById('submitAuth').onclick = handleAuth;
document.getElementById('closeModal').onclick = () => document.getElementById('authModal').classList.add('hidden');

/* =======================
   THE LOOP-BREAKER GUARD
======================= */
supabaseClient.auth.onAuthStateChange((event, session) => {
    if (session) {
        updateUI(true);
        // Path check: ensures this page doesn't try to redirect if you are already on the dashboard
        const path = window.location.pathname;
        if (path.endsWith('index.html') || path === '/' || path.includes('teppatrading.com')) {
            console.log("Session confirmed, replacing index with dashboard...");
            window.location.replace("dashboard.html");
        }
    } else {
        updateUI(false);
    }
});
</script>
</body>
</html>
